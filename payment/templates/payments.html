<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Make Payment</title>
  <script>
    async function initiatePayment() {
      const total = document.getElementById("total").value;
      const reservationCode = document.getElementById("reservation_code").value;
      const firstName = document.getElementById("first_name").value;
      const lastName = document.getElementById("last_name").value;
      const phone = document.getElementById("phone").value;
      const paymentMethod = document.getElementById("payment_method").value;
      
      try {
        const response = await fetch("http://127.0.0.1:8000/api/payments/initiate-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            total: total,
            reservation_code: reservationCode,
            first_name: firstName,
            last_name: lastName,
            phone: phone,
            payment_method: paymentMethod
          })
        });
  
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
        }
  
        const data = await response.json();
        console.log("API Response:", data);
  
        if (data.authorization_url) {
          // Redirect to the payment gateway's authorization URL
          window.location.href = data.authorization_url;
        } else {
          alert("Error: " + (data.error || "Unknown error"));
        }
      } catch (error) {
        console.error("Fetch Error:", error);
        alert("Request failed. Check console for details.");
      }
    }
  </script>
</head>
<body>
  <h1>Make Payment</h1>
  <form onsubmit="event.preventDefault(); initiatePayment();">
    <label for="total">Total (NGN):</label>
    <input type="number" step="0.01" id="total" required /><br/><br/>
    
    <label for="reservation_code">Reservation Code:</label>
    <input type="text" id="reservation_code" required /><br/><br/>
    
    <label for="first_name">First Name:</label>
    <input type="text" id="first_name" required /><br/><br/>
    
    <label for="last_name">Last Name:</label>
    <input type="text" id="last_name" required /><br/><br/>
    
    <label for="phone">Phone:</label>
    <input type="text" id="phone" required /><br/><br/>
    
    <label for="payment_method">Choose Payment Method:</label>
    <select id="payment_method" required>
      <option value="paystack">Paystack</option>
      <option value="flutterwave">Flutterwave</option>
    </select><br/><br/>
    
    <button type="submit">Proceed to Payment</button>
  </form>
  
  <table border="1">
    <thead>
        <tr>
            <th>Amount (NGN)</th>
            <th>Reference</th>
            <th>Payment Method</th>
            <th>Status</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody>
        {% for item in payments %}
        <tr>
            <td>{{ item.original_amount|floatformat:2 }}</td>  {# Display amount with 2 decimal places #}
            <td>{{ item.reference }}</td>
            <td>{{ item.payment_method|title }}</td>  {# Capitalizes first letter #}
            <td>
                {% if item.status == 'successful' %}
                    <span style="color: green;">✔ Successful</span>
                {% elif item.status == 'pending' %}
                    <span style="color: orange;">⏳ Pending</span>
                {% else %}
                    <span style="color: red;">❌ Failed</span>
                {% endif %}
            </td>
            <td>{{ item.created_at|date:"F j, Y g:i A" }}</td>  {# Formats date nicely #}
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" style="text-align: center; color: gray;">No deposits found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div>
  <a href="?filter=all" {% if active_filter == "all" %}class="active"{% endif %}>All</a> |
  <a href="?filter=today" {% if active_filter == "today" %}class="active"{% endif %}>Today</a> |
  <a href="?filter=yesterday" {% if active_filter == "yesterday" %}class="active"{% endif %}>Yesterday</a> |
  <a href="?filter=this_week" {% if active_filter == "this_week" %}class="active"{% endif %}>This Week</a> |
  <a href="?filter=last_week" {% if active_filter == "last_week" %}class="active"{% endif %}>Last Week</a> |
  <a href="?filter=this_month" {% if active_filter == "this_month" %}class="active"{% endif %}>This Month</a>
</div>

    
</body>
</html>
