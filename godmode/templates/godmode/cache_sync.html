{% extends "godmode/base.html" %}
{% load static %}

{% block title %}Cache Sync - God Mode{% endblock %}

{% block extra_css %}
<style>
    .sync-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 20px;
    }
    
    .sync-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .sync-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }
    
    .sync-actions {
        display: flex;
        gap: 10px;
    }
    
    .sync-button {
        background-color: #4a6cf7;
        border: none;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
        font-weight: 600;
        padding: 8px 16px;
        transition: background-color 0.2s;
    }
    
    .sync-button:hover {
        background-color: #3a5ce5;
    }
    
    .sync-button.danger {
        background-color: #dc3545;
    }
    
    .sync-button.danger:hover {
        background-color: #c82333;
    }
    
    .sync-button.warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .sync-button.warning:hover {
        background-color: #e0a800;
    }
    
    .sync-button.success {
        background-color: #28a745;
    }
    
    .sync-button.success:hover {
        background-color: #218838;
    }
    
    .sync-stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-item {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 15px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .model-list {
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
        padding: 15px;
    }
    
    .model-item {
        align-items: center;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
    }
    
    .model-item:last-child {
        border-bottom: none;
    }
    
    .model-name {
        font-weight: 600;
    }
    
    .model-count {
        color: #6c757d;
    }
    
    .sync-log {
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
        padding: 15px;
    }
    
    .log-item {
        border-bottom: 1px solid #dee2e6;
        padding: 10px 0;
    }
    
    .log-item:last-child {
        border-bottom: none;
    }
    
    .log-status {
        display: inline-block;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 10px;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    .log-status.success {
        background-color: #d4edda;
        color: #155724;
    }
    
    .log-status.error {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .log-status.skipped {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .log-message {
        font-size: 0.9rem;
    }
    
    .log-timestamp {
        color: #6c757d;
        font-size: 0.8rem;
        margin-left: 10px;
    }
    
    .loading {
        align-items: center;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        height: 100%;
        justify-content: center;
        left: 0;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1000;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .alert {
        border-radius: 4px;
        margin-bottom: 20px;
        padding: 15px;
    }
    
    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeeba;
        color: #856404;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="sync-card">
                <div class="sync-header">
                    <h1 class="sync-title">Cache Synchronization</h1>
                    <div class="sync-actions">
                        <button id="sync-all-button" class="sync-button">Sync All Models</button>
                        <button id="sync-all-force-button" class="sync-button warning">Force Sync All</button>
                    </div>
                </div>
                
                <div id="alerts-container"></div>
                
                <div class="sync-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-keys">-</div>
                        <div class="stat-label">Total Keys</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="synced-keys">-</div>
                        <div class="stat-label">Synced Keys</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="skipped-keys">-</div>
                        <div class="stat-label">Skipped Keys</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="error-keys">-</div>
                        <div class="stat-label">Error Keys</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="elapsed-time">-</div>
                        <div class="stat-label">Elapsed Time (s)</div>
                    </div>
                </div>
                
                <h2>Models</h2>
                <div class="model-list" id="model-list">
                    <!-- Models will be populated here -->
                </div>
                
                <h2>Sync Log</h2>
                <div class="sync-log" id="sync-log">
                    <!-- Sync log will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading" id="loading" style="display: none;">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get elements
        const syncAllButton = document.getElementById('sync-all-button');
        const syncAllForceButton = document.getElementById('sync-all-force-button');
        const modelList = document.getElementById('model-list');
        const syncLog = document.getElementById('sync-log');
        const loading = document.getElementById('loading');
        const alertsContainer = document.getElementById('alerts-container');
        
        // Stats elements
        const totalKeysElement = document.getElementById('total-keys');
        const syncedKeysElement = document.getElementById('synced-keys');
        const skippedKeysElement = document.getElementById('skipped-keys');
        const errorKeysElement = document.getElementById('error-keys');
        const elapsedTimeElement = document.getElementById('elapsed-time');
        
        // Load models
        loadModels();
        
        // Add event listeners
        syncAllButton.addEventListener('click', function() {
            syncAll(false);
        });
        
        syncAllForceButton.addEventListener('click', function() {
            if (confirm('Are you sure you want to force sync all models? This will overwrite database data with cache data even if the database is newer.')) {
                syncAll(true);
            }
        });
        
        // Function to load models
        function loadModels() {
            showLoading();
            
            fetch('/godmode/api/exports/models')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    
                    // Clear model list
                    modelList.innerHTML = '';
                    
                    // Add models
                    data.forEach(model => {
                        const modelItem = document.createElement('div');
                        modelItem.className = 'model-item';
                        
                        const modelName = document.createElement('div');
                        modelName.className = 'model-name';
                        modelName.textContent = model.name;
                        
                        const modelActions = document.createElement('div');
                        modelActions.className = 'model-actions';
                        
                        const syncButton = document.createElement('button');
                        syncButton.className = 'sync-button';
                        syncButton.textContent = 'Sync';
                        syncButton.addEventListener('click', function() {
                            syncModel(model.name, false);
                        });
                        
                        const forceSyncButton = document.createElement('button');
                        forceSyncButton.className = 'sync-button warning';
                        forceSyncButton.textContent = 'Force Sync';
                        forceSyncButton.addEventListener('click', function() {
                            if (confirm(`Are you sure you want to force sync ${model.name}? This will overwrite database data with cache data even if the database is newer.`)) {
                                syncModel(model.name, true);
                            }
                        });
                        
                        modelActions.appendChild(syncButton);
                        modelActions.appendChild(document.createTextNode(' '));
                        modelActions.appendChild(forceSyncButton);
                        
                        modelItem.appendChild(modelName);
                        modelItem.appendChild(modelActions);
                        
                        modelList.appendChild(modelItem);
                    });
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Error loading models: ' + error.message, 'danger');
                });
        }
        
        // Function to sync all models
        function syncAll(force) {
            showLoading();
            
            // Clear sync log
            syncLog.innerHTML = '';
            
            // Reset stats
            totalKeysElement.textContent = '-';
            syncedKeysElement.textContent = '-';
            skippedKeysElement.textContent = '-';
            errorKeysElement.textContent = '-';
            elapsedTimeElement.textContent = '-';
            
            fetch('/godmode/api/cache/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    model_name: null,
                    force: force
                })
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    
                    if (data.status === 'error') {
                        showAlert(data.message, 'danger');
                        return;
                    }
                    
                    // Show success message
                    showAlert('Cache sync completed successfully', 'success');
                    
                    // Update stats
                    const stats = data.result.stats;
                    totalKeysElement.textContent = stats.total_keys;
                    syncedKeysElement.textContent = stats.synced_keys;
                    skippedKeysElement.textContent = stats.skipped_keys;
                    errorKeysElement.textContent = stats.error_keys;
                    elapsedTimeElement.textContent = data.result.elapsed_time.toFixed(2);
                    
                    // Update sync log
                    updateSyncLog(data.result.log);
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Error syncing cache: ' + error.message, 'danger');
                });
        }
        
        // Function to sync a specific model
        function syncModel(modelName, force) {
            showLoading();
            
            // Clear sync log
            syncLog.innerHTML = '';
            
            // Reset stats
            totalKeysElement.textContent = '-';
            syncedKeysElement.textContent = '-';
            skippedKeysElement.textContent = '-';
            errorKeysElement.textContent = '-';
            elapsedTimeElement.textContent = '-';
            
            fetch('/godmode/api/cache/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    model_name: modelName,
                    force: force
                })
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    
                    if (data.status === 'error') {
                        showAlert(data.message, 'danger');
                        return;
                    }
                    
                    // Show success message
                    showAlert(`Cache sync for ${modelName} completed successfully`, 'success');
                    
                    // Update stats
                    const stats = data.result.stats;
                    totalKeysElement.textContent = stats.total_keys;
                    syncedKeysElement.textContent = stats.synced_keys;
                    skippedKeysElement.textContent = stats.skipped_keys;
                    errorKeysElement.textContent = stats.error_keys;
                    elapsedTimeElement.textContent = data.result.elapsed_time.toFixed(2);
                    
                    // Update sync log
                    updateSyncLog(data.result.log);
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Error syncing cache: ' + error.message, 'danger');
                });
        }
        
        // Function to update sync log
        function updateSyncLog(logs) {
            // Clear sync log
            syncLog.innerHTML = '';
            
            // Add logs
            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                
                const logStatus = document.createElement('span');
                logStatus.className = `log-status ${log.status}`;
                logStatus.textContent = log.status.toUpperCase();
                
                const logMessage = document.createElement('span');
                logMessage.className = 'log-message';
                logMessage.textContent = log.message;
                
                const logTimestamp = document.createElement('span');
                logTimestamp.className = 'log-timestamp';
                logTimestamp.textContent = new Date(log.timestamp).toLocaleString();
                
                logItem.appendChild(logStatus);
                logItem.appendChild(logMessage);
                logItem.appendChild(logTimestamp);
                
                syncLog.appendChild(logItem);
            });
        }
        
        // Function to show loading spinner
        function showLoading() {
            loading.style.display = 'flex';
        }
        
        // Function to hide loading spinner
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        // Function to show alert
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
