{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
<style>
    .metrics-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .metric-card {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 15px;
    }
    
    .metric-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #447e9b;
    }
    
    .metric-value {
        font-size: 24px;
        font-weight: bold;
    }
    
    .metric-subtitle {
        font-size: 12px;
        color: #666;
    }
    
    .chart-container {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 15px;
        margin-bottom: 20px;
        height: 300px;
    }
    
    .table-container {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 15px;
        margin-bottom: 20px;
        overflow-x: auto;
    }
    
    table.data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    table.data-table th, table.data-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    table.data-table th {
        background-color: #f2f2f2;
    }
    
    .success {
        color: #28a745;
    }
    
    .error {
        color: #dc3545;
    }
    
    .warning {
        color: #ffc107;
    }
    
    .test-form {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .test-form input[type="text"] {
        width: 70%;
        padding: 8px;
        margin-right: 10px;
    }
    
    .test-form select {
        padding: 8px;
        margin-right: 10px;
    }
    
    .test-form button {
        padding: 8px 15px;
        background-color: #447e9b;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    
    .test-form button:hover {
        background-color: #366b81;
    }
    
    .last-updated {
        font-size: 12px;
        color: #666;
        text-align: right;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>{{ title }}</h1>
    
    <div class="test-form">
        <h2>Test Geocoding</h2>
        <form id="geocoding-test-form">
            <input type="text" id="address" name="address" placeholder="Enter address to geocode" required>
            <select id="provider" name="provider">
                <option value="">Auto (use default providers)</option>
                <option value="google">Google Maps</option>
                <option value="nominatim">Nominatim (OpenStreetMap)</option>
                <option value="mapbox">Mapbox</option>
            </select>
            <button type="submit">Test</button>
        </form>
        <div id="test-results" style="margin-top: 15px; display: none;"></div>
    </div>
    
    <div class="metrics-container">
        <div class="metric-card">
            <div class="metric-title">Total Operations</div>
            <div class="metric-value" id="total-operations">-</div>
            <div class="metric-subtitle">Geocoding operations processed</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Success Rate</div>
            <div class="metric-value" id="success-rate">-</div>
            <div class="metric-subtitle">Percentage of successful operations</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Cache Hit Rate</div>
            <div class="metric-value" id="cache-hit-rate">-</div>
            <div class="metric-subtitle">Percentage of operations served from cache</div>
        </div>
        
        <div class="metric-card">
            <div class="metric-title">Average Response Time</div>
            <div class="metric-value" id="avg-response-time">-</div>
            <div class="metric-subtitle">Average time to geocode an address</div>
        </div>
    </div>
    
    <div class="chart-container">
        <div class="metric-title">Hourly Operations</div>
        <canvas id="hourly-chart"></canvas>
    </div>
    
    <div class="chart-container">
        <div class="metric-title">Provider Distribution</div>
        <canvas id="provider-chart"></canvas>
    </div>
    
    <div class="table-container">
        <div class="metric-title">Recent Operations</div>
        <table class="data-table" id="recent-operations">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Address</th>
                    <th>Provider</th>
                    <th>Status</th>
                    <th>Cache</th>
                    <th>Time (s)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6">Loading data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="table-container">
        <div class="metric-title">Provider Metrics</div>
        <table class="data-table" id="provider-metrics">
            <thead>
                <tr>
                    <th>Provider</th>
                    <th>Operations</th>
                    <th>Success Rate</th>
                    <th>Cache Hit Rate</th>
                    <th>Avg Time (s)</th>
                    <th>Errors</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="6">Loading data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="table-container">
        <div class="metric-title">Cache Statistics</div>
        <table class="data-table" id="cache-stats">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="2">Loading data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="last-updated">
        Last updated: <span id="last-updated">-</span>
        <button id="refresh-button" style="margin-left: 10px;">Refresh Now</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Charts
    let hourlyChart = null;
    let providerChart = null;
    
    // Auto-refresh timer
    let refreshTimer = null;
    const refreshInterval = {{ refresh_interval }} * 1000; // Convert to milliseconds
    
    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
        // Initial data load
        loadDashboardData();
        
        // Set up auto-refresh
        refreshTimer = setInterval(loadDashboardData, refreshInterval);
        
        // Set up manual refresh button
        document.getElementById('refresh-button').addEventListener('click', loadDashboardData);
        
        // Set up geocoding test form
        document.getElementById('geocoding-test-form').addEventListener('submit', function(e) {
            e.preventDefault();
            testGeocoding();
        });
    });
    
    // Load dashboard data from API
    function loadDashboardData() {
        fetch('/godmode/api/geocoding/metrics/')
            .then(response => response.json())
            .then(data => {
                updateDashboard(data);
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error loading dashboard data:', error);
            });
    }
    
    // Update dashboard with new data
    function updateDashboard(data) {
        // Update summary metrics
        const overall = data.overall_metrics;
        document.getElementById('total-operations').textContent = overall.total_operations;
        document.getElementById('success-rate').textContent = overall.success_rate + '%';
        document.getElementById('cache-hit-rate').textContent = overall.cache_hit_rate + '%';
        document.getElementById('avg-response-time').textContent = overall.average_response_time + 's';
        
        // Update hourly chart
        updateHourlyChart(data.time_metrics.hourly);
        
        // Update provider chart
        updateProviderChart(overall.provider_metrics);
        
        // Update recent operations table
        updateRecentOperationsTable(data.recent_operations);
        
        // Update provider metrics table
        updateProviderMetricsTable(overall.provider_metrics);
        
        // Update cache stats table
        updateCacheStatsTable(data.cache_stats);
    }
    
    // Update hourly operations chart
    function updateHourlyChart(hourlyData) {
        const ctx = document.getElementById('hourly-chart').getContext('2d');
        
        // Prepare data
        const labels = hourlyData.map(h => h.hour.split('-')[3] + ':00'); // Extract hour
        const operations = hourlyData.map(h => h.operations);
        const successRates = hourlyData.map(h => h.success_rate);
        const cacheHitRates = hourlyData.map(h => h.cache_hit_rate);
        
        // Create or update chart
        if (hourlyChart) {
            hourlyChart.data.labels = labels;
            hourlyChart.data.datasets[0].data = operations;
            hourlyChart.data.datasets[1].data = successRates;
            hourlyChart.data.datasets[2].data = cacheHitRates;
            hourlyChart.update();
        } else {
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Operations',
                            data: operations,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Success Rate (%)',
                            data: successRates,
                            type: 'line',
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Cache Hit Rate (%)',
                            data: cacheHitRates,
                            type: 'line',
                            backgroundColor: 'rgba(255, 159, 64, 0.5)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Operations'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Rate (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Update provider distribution chart
    function updateProviderChart(providerMetrics) {
        const ctx = document.getElementById('provider-chart').getContext('2d');
        
        // Prepare data
        const providers = Object.keys(providerMetrics);
        const operations = providers.map(p => providerMetrics[p].total_operations);
        const successRates = providers.map(p => {
            const metrics = providerMetrics[p];
            return metrics.total_operations > 0 
                ? (metrics.successful_operations / metrics.total_operations * 100).toFixed(1)
                : 0;
        });
        
        // Create or update chart
        if (providerChart) {
            providerChart.data.labels = providers;
            providerChart.data.datasets[0].data = operations;
            providerChart.data.datasets[1].data = successRates;
            providerChart.update();
        } else {
            providerChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: providers,
                    datasets: [
                        {
                            label: 'Operations',
                            data: operations,
                            backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Success Rate (%)',
                            data: successRates,
                            type: 'line',
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Operations'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Success Rate (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Update recent operations table
    function updateRecentOperationsTable(operations) {
        const tbody = document.querySelector('#recent-operations tbody');
        tbody.innerHTML = '';
        
        operations.forEach(op => {
            const row = document.createElement('tr');
            
            // Format timestamp
            const timestamp = new Date(op.timestamp);
            const timeStr = timestamp.toLocaleTimeString();
            
            // Create table cells
            row.innerHTML = `
                <td>${timeStr}</td>
                <td title="${op.address}">${truncateText(op.address, 30)}</td>
                <td>${op.provider || '-'}</td>
                <td class="${op.success ? 'success' : 'error'}">${op.success ? 'Success' : 'Failed'}</td>
                <td>${op.cache_hit ? 'Hit' : 'Miss'}</td>
                <td>${op.total_time ? op.total_time.toFixed(3) : '-'}</td>
            `;
            
            tbody.appendChild(row);
        });
        
        if (operations.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="6">No operations recorded yet</td>';
            tbody.appendChild(row);
        }
    }
    
    // Update provider metrics table
    function updateProviderMetricsTable(providerMetrics) {
        const tbody = document.querySelector('#provider-metrics tbody');
        tbody.innerHTML = '';
        
        Object.entries(providerMetrics).forEach(([provider, metrics]) => {
            const row = document.createElement('tr');
            
            // Calculate rates
            const successRate = metrics.total_operations > 0 
                ? (metrics.successful_operations / metrics.total_operations * 100).toFixed(1)
                : 0;
            
            const cacheHitRate = metrics.total_operations > 0 
                ? (metrics.cache_hits / metrics.total_operations * 100).toFixed(1)
                : 0;
            
            const avgTime = metrics.total_operations > 0 
                ? (metrics.total_time / metrics.total_operations).toFixed(3)
                : '-';
            
            // Create table cells
            row.innerHTML = `
                <td>${provider}</td>
                <td>${metrics.total_operations}</td>
                <td class="${successRate > 90 ? 'success' : successRate > 70 ? 'warning' : 'error'}">${successRate}%</td>
                <td>${cacheHitRate}%</td>
                <td>${avgTime}</td>
                <td>${metrics.error_count || 0}</td>
            `;
            
            tbody.appendChild(row);
        });
        
        if (Object.keys(providerMetrics).length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="6">No provider metrics available</td>';
            tbody.appendChild(row);
        }
    }
    
    // Update cache stats table
    function updateCacheStatsTable(cacheStats) {
        const tbody = document.querySelector('#cache-stats tbody');
        tbody.innerHTML = '';
        
        // Add rows for each cache stat
        addCacheStatRow(tbody, 'Total Entries', cacheStats.total_entries || 0);
        addCacheStatRow(tbody, 'Memory Used', formatBytes(cacheStats.memory_used_bytes || 0));
        addCacheStatRow(tbody, 'Hit Count', cacheStats.hit_count || 0);
        addCacheStatRow(tbody, 'Miss Count', cacheStats.miss_count || 0);
        
        if (cacheStats.hit_count || cacheStats.miss_count) {
            const totalLookups = (cacheStats.hit_count || 0) + (cacheStats.miss_count || 0);
            const hitRate = totalLookups > 0 
                ? ((cacheStats.hit_count || 0) / totalLookups * 100).toFixed(1)
                : 0;
            addCacheStatRow(tbody, 'Hit Rate', hitRate + '%');
        }
        
        // Add age distribution if available
        if (cacheStats.age_distribution) {
            addCacheStatRow(tbody, 'Age Distribution', '');
            Object.entries(cacheStats.age_distribution).forEach(([age, count]) => {
                addCacheStatRow(tbody, '  ' + age, count);
            });
        }
    }
    
    // Helper function to add a row to the cache stats table
    function addCacheStatRow(tbody, label, value) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${label}</td>
            <td>${value}</td>
        `;
        tbody.appendChild(row);
    }
    
    // Test geocoding with the provided address
    function testGeocoding() {
        const address = document.getElementById('address').value;
        const provider = document.getElementById('provider').value;
        
        if (!address) {
            alert('Please enter an address to geocode');
            return;
        }
        
        const resultsDiv = document.getElementById('test-results');
        resultsDiv.innerHTML = '<p>Testing geocoding for: ' + address + '...</p>';
        resultsDiv.style.display = 'block';
        
        // Build URL with parameters
        let url = '/godmode/api/geocoding/test/?address=' + encodeURIComponent(address);
        if (provider) {
            url += '&provider=' + encodeURIComponent(provider);
        }
        
        // Make API request
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // Format and display results
                let resultHtml = '<h3>Geocoding Results</h3>';
                
                if (data.success) {
                    resultHtml += `
                        <p class="success">✅ Success</p>
                        <p><strong>Coordinates:</strong> ${data.latitude}, ${data.longitude}</p>
                        <p><strong>Provider:</strong> ${data.provider}</p>
                        <p><strong>Time:</strong> ${data.total_time.toFixed(3)}s</p>
                        <p><strong>Cache:</strong> ${data.cache_hit ? 'Hit' : 'Miss'}</p>
                    `;
                    
                    if (data.formatted_address) {
                        resultHtml += `<p><strong>Formatted Address:</strong> ${data.formatted_address}</p>`;
                    }
                    
                    // Add Google Maps link
                    resultHtml += `
                        <p><a href="https://www.google.com/maps?q=${data.latitude},${data.longitude}" target="_blank">
                            View on Google Maps
                        </a></p>
                    `;
                } else {
                    resultHtml += `
                        <p class="error">❌ Error: ${data.error}</p>
                        <p><strong>Error Type:</strong> ${data.error_type}</p>
                        <p><strong>Time:</strong> ${data.total_time.toFixed(3)}s</p>
                    `;
                    
                    if (data.provider) {
                        resultHtml += `<p><strong>Provider:</strong> ${data.provider}</p>`;
                    }
                    
                    if (data.error_details) {
                        resultHtml += '<p><strong>Error Details:</strong></p><pre>' + 
                            JSON.stringify(data.error_details, null, 2) + '</pre>';
                    }
                }
                
                resultsDiv.innerHTML = resultHtml;
                
                // Refresh dashboard data after test
                loadDashboardData();
            })
            .catch(error => {
                resultsDiv.innerHTML = '<p class="error">Error testing geocoding: ' + error.message + '</p>';
                console.error('Error testing geocoding:', error);
            });
    }
    
    // Helper function to truncate text
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
    
    // Helper function to format bytes
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
</script>
{% endblock %}
