{% extends 'godmode/base.html' %}

{% block title %}Security Dashboard - Payshift God Mode{% endblock %}

{% block extra_css %}
<style>
    .security-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dc3545;
    }
    
    .security-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .security-card .card-header {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        font-weight: bold;
    }
    
    .control-card {
        border-left: 4px solid #17a2b8;
    }
    
    .control-card .card-header {
        background-color: rgba(23, 162, 184, 0.1);
        color: #17a2b8;
        font-weight: bold;
    }
    
    .insights-card {
        border-left: 4px solid #28a745;
    }
    
    .insights-card .card-header {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
        font-weight: bold;
    }
    
    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    
    .status-enabled {
        background-color: #28a745;
    }
    
    .status-disabled {
        background-color: #dc3545;
    }
    
    .alert-item {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
        border-left: 3px solid #dc3545;
    }
    
    .alert-item .timestamp {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .alert-item .alert-message {
        font-weight: 500;
    }
    
    .alert-item .alert-actions {
        margin-top: 5px;
    }
    
    .real-time-container {
        height: 400px;
        overflow-y: auto;
    }
    
    .activity-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
    }
    
    .activity-item:hover {
        background-color: #f8f9fa;
    }
    
    .activity-item .timestamp {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    #map {
        height: 400px;
        border-radius: 5px;
    }
    
    .chart-container {
        height: 300px;
    }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1>Security & Business Insights Dashboard</h1>
    <div>
        <button id="refreshBtn" class="btn btn-primary">
            <i class="bi bi-arrow-repeat"></i> Refresh Data
        </button>
    </div>
</div>

<!-- System Status -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">System Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="status-indicator" id="jobCreationStatus"></span>
                                <span>Job Creation</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" id="toggleJobCreation">
                                <i class="bi bi-toggle-on"></i> Toggle
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="status-indicator" id="paymentProcessingStatus"></span>
                                <span>Payment Processing</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" id="togglePaymentProcessing">
                                <i class="bi bi-toggle-on"></i> Toggle
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="status-indicator" id="userRegistrationStatus"></span>
                                <span>User Registration</span>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" id="toggleUserRegistration">
                                <i class="bi bi-toggle-on"></i> Toggle
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card mb-0">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">Blocked Users</h6>
                            </div>
                            <div class="card-body">
                                <div id="blockedUsers">
                                    <p class="text-muted">No users are currently blocked.</p>
                                </div>
                                <div class="mt-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="userIdInput" placeholder="Enter User ID">
                                        <button class="btn btn-outline-danger" id="blockUserBtn">Block User</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-0">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">Blocked IP Addresses</h6>
                            </div>
                            <div class="card-body">
                                <div id="blockedIPs">
                                    <p class="text-muted">No IP addresses are currently blocked.</p>
                                </div>
                                <div class="mt-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="ipInput" placeholder="Enter IP Address">
                                        <button class="btn btn-outline-danger" id="blockIPBtn">Block IP</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Monitoring -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card security-card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Security Alerts</h5>
            </div>
            <div class="card-body">
                <div id="securityAlerts" class="real-time-container">
                    <p class="text-muted">No security alerts at this time.</p>
                </div>
                <div class="mt-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="alertInput" placeholder="Create a new alert">
                        <button class="btn btn-outline-danger" id="addAlertBtn">Add Alert</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card control-card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">Real-time Activity</h5>
            </div>
            <div class="card-body">
                <div id="realtimeActivity" class="real-time-container">
                    <p class="text-muted">Waiting for activity data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats and Insights -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card insights-card">
            <div class="card-header">
                <h5 class="card-title mb-0">Active Users</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value" id="activeUsers">--</div>
                        <div class="stat-label">Last Hour</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-people"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card insights-card">
            <div class="card-header">
                <h5 class="card-title mb-0">New Jobs</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value" id="newJobs">--</div>
                        <div class="stat-label">Last Hour</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-briefcase"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card insights-card">
            <div class="card-header">
                <h5 class="card-title mb-0">New Payments</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value" id="newPayments">--</div>
                        <div class="stat-label">Last Hour</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-credit-card"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card security-card">
            <div class="card-header">
                <h5 class="card-title mb-0">Failed Payments</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value" id="failedPayments">--</div>
                        <div class="stat-label">Last Hour</div>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Maps -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">User Activity Trends</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Payment Success Rate</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">User Location Map</h5>
            </div>
            <div class="card-body">
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // WebSocket connection
        let socket;
        let adminId = 1; // Replace with actual admin ID
        let systemStatus = {
            job_creation_enabled: true,
            payment_processing_enabled: true,
            user_registration_enabled: true,
            system_alerts: [],
            blocked_users: [],
            blocked_ips: []
        };
        
        // Initialize charts
        const activityCtx = document.getElementById('activityChart').getContext('2d');
        const activityChart = new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => `${23-i}h ago`).reverse(),
                datasets: [{
                    label: 'User Logins',
                    data: Array(24).fill(0),
                    borderColor: '#4a6cf7',
                    tension: 0.1,
                    fill: false
                }, {
                    label: 'Job Applications',
                    data: Array(24).fill(0),
                    borderColor: '#28a745',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        const paymentCtx = document.getElementById('paymentChart').getContext('2d');
        const paymentChart = new Chart(paymentCtx, {
            type: 'doughnut',
            data: {
                labels: ['Successful', 'Failed', 'Pending'],
                datasets: [{
                    data: [70, 20, 10],
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Initialize map
        const map = L.map('map').setView([6.5244, 3.3792], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // User markers
        const userMarkers = [];
        
        // Connect to WebSocket
        function connectWebSocket() {
            socket = new WebSocket(`ws://${window.location.host}/godmode/api/ws`);
            
            socket.onopen = function(e) {
                console.log('WebSocket connection established');
                // Send ping to keep connection alive
                setInterval(() => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({type: 'ping'}));
                    }
                }, 30000);
            };
            
            socket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                
                if (message.type === 'system_status') {
                    updateSystemStatus(message.data);
                } else if (message.type === 'stats_update') {
                    updateStats(message.data);
                } else if (message.type === 'activity_update') {
                    updateActivity(message.data);
                } else if (message.type === 'security_alerts') {
                    updateSecurityAlerts(message.data);
                }
            };
            
            socket.onclose = function(event) {
                console.log('WebSocket connection closed');
                // Try to reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }
        
        // Update system status
        function updateSystemStatus(status) {
            systemStatus = status;
            
            // Update status indicators
            document.getElementById('jobCreationStatus').className = 
                'status-indicator ' + (status.job_creation_enabled ? 'status-enabled' : 'status-disabled');
            
            document.getElementById('paymentProcessingStatus').className = 
                'status-indicator ' + (status.payment_processing_enabled ? 'status-enabled' : 'status-disabled');
            
            document.getElementById('userRegistrationStatus').className = 
                'status-indicator ' + (status.user_registration_enabled ? 'status-enabled' : 'status-disabled');
            
            // Update blocked users
            const blockedUsersEl = document.getElementById('blockedUsers');
            if (status.blocked_users.length > 0) {
                let html = '<ul class="list-group">';
                status.blocked_users.forEach(userId => {
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            User ID: ${userId}
                            <button class="btn btn-sm btn-outline-success unblock-user" data-user-id="${userId}">
                                <i class="bi bi-unlock"></i> Unblock
                            </button>
                        </li>
                    `;
                });
                html += '</ul>';
                blockedUsersEl.innerHTML = html;
                
                // Add event listeners for unblock buttons
                document.querySelectorAll('.unblock-user').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        sendCommand('unblock_user', {user_id: userId});
                    });
                });
            } else {
                blockedUsersEl.innerHTML = '<p class="text-muted">No users are currently blocked.</p>';
            }
            
            // Update blocked IPs
            const blockedIPsEl = document.getElementById('blockedIPs');
            if (status.blocked_ips.length > 0) {
                let html = '<ul class="list-group">';
                status.blocked_ips.forEach(ip => {
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${ip}
                            <button class="btn btn-sm btn-outline-success unblock-ip" data-ip="${ip}">
                                <i class="bi bi-unlock"></i> Unblock
                            </button>
                        </li>
                    `;
                });
                html += '</ul>';
                blockedIPsEl.innerHTML = html;
                
                // Add event listeners for unblock buttons
                document.querySelectorAll('.unblock-ip').forEach(button => {
                    button.addEventListener('click', function() {
                        const ip = this.getAttribute('data-ip');
                        sendCommand('unblock_ip', {ip: ip});
                    });
                });
            } else {
                blockedIPsEl.innerHTML = '<p class="text-muted">No IP addresses are currently blocked.</p>';
            }
            
            // Update security alerts
            const alertsEl = document.getElementById('securityAlerts');
            if (status.system_alerts.length > 0) {
                let html = '';
                status.system_alerts.forEach(alert => {
                    html += `
                        <div class="alert-item">
                            <div class="d-flex justify-content-between">
                                <div class="alert-message">${alert.message}</div>
                                <button class="btn btn-sm btn-outline-danger clear-alert" data-alert-id="${alert.id}">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            <div class="timestamp">${new Date(alert.timestamp).toLocaleString()}</div>
                        </div>
                    `;
                });
                alertsEl.innerHTML = html;
                
                // Add event listeners for clear buttons
                document.querySelectorAll('.clear-alert').forEach(button => {
                    button.addEventListener('click', function() {
                        const alertId = this.getAttribute('data-alert-id');
                        sendCommand('clear_alert', {alert_id: parseInt(alertId)});
                    });
                });
            } else {
                alertsEl.innerHTML = '<p class="text-muted">No security alerts at this time.</p>';
            }
        }
        
        // Update stats
        function updateStats(stats) {
            document.getElementById('activeUsers').textContent = stats.active_users;
            document.getElementById('newJobs').textContent = stats.new_jobs;
            document.getElementById('newPayments').textContent = stats.new_payments;
            document.getElementById('failedPayments').textContent = stats.failed_payments;
            
            // Update payment chart
            const total = stats.new_payments;
            const failed = stats.failed_payments;
            const successful = total - failed;
            
            paymentChart.data.datasets[0].data = [successful, failed, 0];
            paymentChart.update();
            
            // Update activity chart with random data for demo
            // In a real implementation, you would use actual data from the backend
            const loginData = activityChart.data.datasets[0].data;
            loginData.shift();
            loginData.push(Math.floor(Math.random() * 10) + stats.active_users);
            
            const applicationData = activityChart.data.datasets[1].data;
            applicationData.shift();
            applicationData.push(Math.floor(Math.random() * 5) + stats.new_applications);
            
            activityChart.update();
        }
        
        // Update activity feed
        function updateActivity(activities) {
            const activityEl = document.getElementById('realtimeActivity');
            
            if (activities.length > 0) {
                let html = '';
                activities.forEach(activity => {
                    html += `
                        <div class="activity-item">
                            <div class="d-flex justify-content-between">
                                <strong>${activity.user}</strong>
                                <span class="timestamp">${new Date(activity.timestamp).toLocaleTimeString()}</span>
                            </div>
                            <div>${activity.action}</div>
                        </div>
                    `;
                    
                    // Add user to map if location data is available
                    if (activity.details && activity.details.latitude && activity.details.longitude) {
                        addUserToMap(activity.user, activity.details.latitude, activity.details.longitude);
                    }
                });
                activityEl.innerHTML = html;
            } else {
                activityEl.innerHTML = '<p class="text-muted">No activity data available.</p>';
            }
        }
        
        // Update security alerts
        function updateSecurityAlerts(alerts) {
            if (alerts.length > 0) {
                alerts.forEach(alert => {
                    // Add to system alerts if not already present
                    if (!systemStatus.system_alerts.some(a => a.message === alert.message)) {
                        sendCommand('add_alert', {
                            alert: alert.message
                        });
                    }
                });
            }
        }
        
        // Add user to map
        function addUserToMap(username, lat, lng) {
            // Check if user already has a marker
            const existingMarker = userMarkers.find(m => m.username === username);
            
            if (existingMarker) {
                // Update marker position
                existingMarker.marker.setLatLng([lat, lng]);
            } else {
                // Create new marker
                const marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`<strong>${username}</strong><br>Last seen: ${new Date().toLocaleTimeString()}`);
                
                userMarkers.push({
                    username: username,
                    marker: marker
                });
            }
            
            // Adjust map view to show all markers
            if (userMarkers.length > 0) {
                const bounds = L.latLngBounds(userMarkers.map(m => m.marker.getLatLng()));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Send command to server
        function sendCommand(command, data) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'command',
                    command: command,
                    data: {
                        ...data,
                        admin_id: adminId
                    }
                }));
            }
        }
        
        // Event listeners
        document.getElementById('toggleJobCreation').addEventListener('click', function() {
            sendCommand('toggle_job_creation', {});
        });
        
        document.getElementById('togglePaymentProcessing').addEventListener('click', function() {
            sendCommand('toggle_payment_processing', {});
        });
        
        document.getElementById('toggleUserRegistration').addEventListener('click', function() {
            sendCommand('toggle_user_registration', {});
        });
        
        document.getElementById('blockUserBtn').addEventListener('click', function() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (userId) {
                sendCommand('block_user', {user_id: userId});
                document.getElementById('userIdInput').value = '';
            }
        });
        
        document.getElementById('blockIPBtn').addEventListener('click', function() {
            const ip = document.getElementById('ipInput').value.trim();
            if (ip) {
                sendCommand('block_ip', {ip: ip});
                document.getElementById('ipInput').value = '';
            }
        });
        
        document.getElementById('addAlertBtn').addEventListener('click', function() {
            const alert = document.getElementById('alertInput').value.trim();
            if (alert) {
                sendCommand('add_alert', {alert: alert});
                document.getElementById('alertInput').value = '';
            }
        });
        
        document.getElementById('refreshBtn').addEventListener('click', function() {
            // Fetch latest data
            fetch('/godmode/api/stats')
                .then(response => response.json())
                .then(data => updateStats(data))
                .catch(error => console.error('Error fetching stats:', error));
                
            fetch('/godmode/api/activity')
                .then(response => response.json())
                .then(data => updateActivity(data))
                .catch(error => console.error('Error fetching activity:', error));
                
            fetch('/godmode/api/security-alerts')
                .then(response => response.json())
                .then(data => updateSecurityAlerts(data))
                .catch(error => console.error('Error fetching alerts:', error));
        });
        
        // Initialize WebSocket connection
        connectWebSocket();
        
        // Initialize with some random data for the map
        const demoLocations = [
            {username: 'user1', lat: 6.5244, lng: 3.3792},
            {username: 'user2', lat: 6.5350, lng: 3.3892},
            {username: 'user3', lat: 6.5150, lng: 3.3692}
        ];
        
        demoLocations.forEach(loc => {
            addUserToMap(loc.username, loc.lat, loc.lng);
        });
    });
</script>
{% endblock %}
